# 데이터 유기성 및 일관성 조사 결과 보고서

시스템 전수 조사 결과, 데이터의 유기적 연결을 방해하고 개별적으로 동작하거나 하드코딩된 로직들이 다음과 같이 식별되었습니다.

## 1. 하드코딩된 주요 설정 및 비밀키
데이터베이스나 환경 변수로 관리되어야 할 값이 코드 내에 고정되어 있어 유연성이 떨어집니다.
- **`AuthService` / `JwtStrategy`**: `OWMS_SECRET_KEY`, `OWMS_REFRESH_SECRET` 등의 비밀키가 하드코딩되어 있음.
- **`ExcelService`**: 엑셀 템플릿 경로(`D:/AI_PJ/OWMS/excel/양식.xlsx`)가 절대 경로로 하드코딩되어 있음.

## 2. 매직 넘버를 이용한 가상 관계 생성 (위험)
DB 관계를 통하지 않고 애플리케이션 레벨에서 임의의 계산으로 데이터를 매핑하는 사례입니다.
- **`WorkStatusService`**: 팀이 없는 부서 사용자를 처리하기 위해 `teamId: 10000 + dept.id`라는 가상 ID를 생성하여 사용함. 이는 프론트엔드와 백엔드 간에 약속된 매직 넘버가 없으면 데이터 연결이 깨지는 구조입니다.
- **개선안**: `Team` 테이블에 '부서 미지정 팀'을 명시적으로 생성하거나, `null` 처리에 대한 명확한 비즈니스 로직을 API 스펙으로 정의해야 합니다.

## 3. Prisma Schema 관계 설정 누락
- **`WeeklyNote` 모델**: `userId` 필드는 존재하나, `User` 모델과의 정식 `@relation` 설정이 누락되어 있어 Prisma의 `include` 기능을 활용한 유기적 조회가 불가능합니다.

## 4. 파괴적인 데이터 갱신 패턴 (Data Integrity)
- **`ReportsService.saveJobs`**: 기존 실적을 모두 삭제(`deleteMany`)하고 새로 생성(`create`)하는 방식을 사용합니다. 
  - **문제점**: 데이터의 고유 ID가 유지되지 않아 다른 테이블에서 이 업무를 참조할 경우 관계가 깨집니다. 또한 수정 이력(Audit Trail) 관리가 불가능합니다.
  - **개선안**: `upsert` 또는 `id` 기반의 부분 업데이트로 전환해야 합니다.

## 5. 일관성 없는 날짜 및 시간대 처리
- `setHours(0, 0, 0, 0)` 로직이 여러 서비스(`Reports`, `WorkStatus`, `Metrics`, `Excel`)에 중복 구현되어 있습니다. 시스템 전역적으로 KST 기준 날짜 경계를 처리하는 유틸리티가 부재하여, 향후 시간대 관련 버그 발생 위험이 있습니다.

---

> [!CAUTION]
> 특히 `10000 + ID`와 같은 매직 넘버 방식은 시스템 규모가 커짐에 따라 실제 ID와 충돌할 위험이 있으므로 우선적으로 제거해야 합니다.
