# 엑셀 주간 업무 보고서 작성 규범

> 이 문서는 `excel.service.ts`에서 엑셀 파일 생성 시 반드시 준수해야 하는 행 매핑 및 데이터 기입 규칙을 정의합니다.

---

## 1. 템플릿 원칙

- **참조 템플릿**: `D:/AI_PJ/OWMS/excel/양식.xlsx` (데이터가 없는 깨끗한 빈 양식)
- **매 출력 시** 이 양식을 새로 읽어와서 텍스트만 추가한다.
- 양식의 **폰트, 함수, 병합, 테두리, 행 높이** 등 일체의 서식은 수정하지 않는다.
- 오직 **텍스트 값(value)만 기입**한다.

---

## 2. 행 매핑 규범

| 구간 | 행 범위 | 사용 가능 행 수 | 용도 | 수정 가능 여부 |
|------|---------|--------------|------|-------------|
| 헤더 | Row 1 ~ 6 | - | 제목, 보고자, 날짜 범위 | 지정 셀만 기입 |
| **1페이지** | **Row 7 ~ 39** | **33행** | 업무 제목/내용/근무형태 | ✅ 데이터 기입 |
| **중요정보** | **Row 40 ~ 44** | **5행** | **주간 중요정보 사항** | ✅ 가변 기입 |
| **2페이지** | **Row 45 ~ 84** | **40행** | 넘침 데이터 이어서 기입 | ✅ 데이터 기입 |
| **3페이지+** | **Row 85...** | **40행씩** | 추가 넘침 데이터 (2페이지 복제) | ✅ 동적 확장 |

### 핵심 규칙 (주간 중요정보 사항)

1.  **기입 위치**: Row 41 ~ 44 구간을 사용한다.
2.  **데이터 소스**: DB의 `WeeklyNote` 데이터를 사용한다.
3.  **데이터 기입 방식**: 내용을 **줄바꿈(`\n`) 기준으로 분리**하여 각각의 행(`D41`, `D42`, `D43`, `D44`)에 순차적으로 기입한다.
4.  **입력 제한 (유효성 검사)**:
    -   **최대 행 수**: 4줄 이내.
    -   **최대 글자 수**: 한 줄당 40자 이내.
    -   **실시간 검증**: 프론트엔드에서 입력 시 즉시 체크하며, 위반 시 저장을 차단한다.
5.  **데이터 부재 시**: Row 40 ~ 44 구간의 모든 내용(레이블 포함)을 완전히 삭제하여 빈 공간으로 만든다.

### 핵심 규칙 (데이터 영역 및 무제한 확장)

1.  **기본 데이터 영역**: Row 7 ~ 39 및 Row 45 ~ 84를 사용한다. (Row 40~44는 업무 데이터가 기입되지 않도록 건너뛴다.)
2.  **동적 확장**: 주 데이터(업무 내용)가 84행을 초과하는 경우, **Row 45 ~ 84 구간의 서식과 병합 정보**를 그대로 복사하여 Row 85부터 새로운 페이지를 생성한다.
3.  **반복**: 필요한 만큼 40행 단위로 계속 확장한다. (예: 85~124, 125~164...)
4.  **Row 6 날짜 자동화**: 월요일 날짜 기입(C6) 시, 나머지 날짜 셀(E6, H6, J6)은 `yyyy년 mm월 dd일` 형식의 시리얼 값으로 자동 환산되어 기입된다.

---

## 3. 셀 병합 구조 (데이터 영역)

각 데이터 행에는 다음 병합이 적용된다:

| 영역 | 병합 범위 | 용도 |
|------|----------|------|
| 좌측 요일 | `A:B` | 월(09), 화(10) 등 |
| 좌측 내용 | `C:E` | 금주 실시사항 (업무 제목/내용) |
| 우측 요일 | `F:G` | 월(16), 화(17) 등 |
| 우측 내용 | `H:N` | 차주 계획 (업무 제목/내용) |

---

## 4. 기술적 개선 가이드 (Technical Improvements)

현재 `ExcelService`는 거대 서비스(God Service)로 기능하고 있습니다. 향후 유지보수를 위해 다음과 같은 개선을 권장합니다:

1.  **관심사 분리 (SOC)**:
    -   `ExcelTemplateService`: 템플릿 로딩, 복제, 서식 관리 전문화
    -   `ExcelDataService`: 보고서에 필요한 DB 데이터 집계 및 가공(Job, Vacation, WeeklyNote 등) 전문화
    -   `ExcelFormatter`: 셀 스타일링 및 텍스트 포맷팅 유틸리티 분리
2.  **캐싱**: 템플릿 파일 로딩 시 매번 디스크 I/O를 발생시키기보다 `Buffer` 형태로 메모리에 캐싱하여 성능 향상.
3.  **병렬 처리**: 팀 전체 보고서 생성 시 `Promise.all`을 활용하여 각 팀원별 엑셀 생성을 병렬로 수행 (Prisma의 커넥션 풀 고려 필요).

---

## 5. 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2026-02-12 | 1. 기술적 개선 가이드 섹션 추가 (관심사 분리, 캐싱 등) |
| 2026-02-10 | 1. Row 40-44 주간 정보 사항 연동 규범 정의 (행 분리 기입) |
| | 2. 주간 정보 사항 유효성 검사 규칙 추가 (4줄 / 줄당 40자) |
| | 3. 무제한 페이지 확장 및 Row 45~84 복제 로직 명시 |
| | 4. Row 6 날짜 포맷 표준화 (`yyyy년 mm월 dd일`) |
